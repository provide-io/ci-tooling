name: 'Python CI Pipeline'
description: 'Comprehensive Python CI pipeline with testing, quality checks, and building'
author: 'provide.io llc'

inputs:
  python-version:
    description: 'Python version to install'
    required: false
    default: '3.11'
  mode:
    description: 'CI mode: test, build, or full'
    required: false
    default: 'full'
  test-directory:
    description: 'Directory containing tests'
    required: false
    default: 'tests/'
  source-directory:
    description: 'Directory containing source code'
    required: false
    default: 'src/'
  coverage-threshold:
    description: 'Minimum coverage threshold percentage'
    required: false
    default: '80'
  run-quality-checks:
    description: 'Enable code quality checks (ruff, mypy)'
    required: false
    default: 'true'
  run-security-scan:
    description: 'Enable security scanning'
    required: false
    default: 'false'
  dependency-groups:
    description: 'Dependency groups to install (for PEP 735)'
    required: false
    default: 'dev'
  upload-artifacts:
    description: 'Upload build artifacts'
    required: false
    default: 'true'

outputs:
  python-version:
    description: 'Installed Python version'
    value: ${{ steps.python.outputs.python-version }}
  coverage-percentage:
    description: 'Test coverage percentage'
    value: ${{ steps.test.outputs.coverage }}
  build-success:
    description: 'Whether build was successful'
    value: ${{ steps.build.outputs.success }}
  package-version:
    description: 'Built package version'
    value: ${{ steps.build.outputs.version }}

runs:
  using: 'composite'
  steps:
    - name: ðŸ Setup Python
      id: python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}

    - name: ðŸ“¦ Setup UV
      uses: astral-sh/setup-uv@v4

    - name: ðŸ”§ Install Dependencies
      shell: bash
      run: |
        echo "ðŸ”§ Installing project dependencies..."

        # Install the project in development mode with dependency groups
        if [ -f "pyproject.toml" ] && grep -q "\[dependency-groups\]" pyproject.toml; then
          echo "ðŸ“‹ Installing with dependency groups: ${{ inputs.dependency-groups }}"
          uv pip install --system -e . --group ${{ inputs.dependency-groups }}
        elif [ -f "pyproject.toml" ] && grep -q "\[project.optional-dependencies\]" pyproject.toml; then
          echo "ðŸ“‹ Installing with optional dependencies: ${{ inputs.dependency-groups }}"
          uv pip install --system -e .[${{ inputs.dependency-groups }}]
        else
          echo "ðŸ“‹ Installing basic project"
          uv pip install --system -e .
        fi

        echo "âœ… Dependencies installed"

    - name: ðŸŽ¨ Code Quality Checks
      if: inputs.run-quality-checks == 'true' && (inputs.mode == 'full' || inputs.mode == 'quality')
      shell: bash
      run: |
        echo "ðŸŽ¨ Running code quality checks..."

        # Check if ruff is available
        if command -v ruff >/dev/null 2>&1; then
          echo "ðŸ” Running ruff check..."
          ruff check ${{ inputs.source-directory }} || echo "âš ï¸ Ruff check issues found"

          echo "ðŸ“ Checking ruff format..."
          ruff format --check ${{ inputs.source-directory }} || echo "âš ï¸ Format issues found"
        else
          echo "âš ï¸ Ruff not available, skipping format checks"
        fi

        # Check if mypy is available
        if command -v mypy >/dev/null 2>&1; then
          echo "ðŸ” Running mypy..."
          mypy ${{ inputs.source-directory }} || echo "âš ï¸ Type check issues found"
        else
          echo "âš ï¸ MyPy not available, skipping type checks"
        fi

        echo "âœ… Quality checks completed"

    - name: ðŸ”’ Security Scan
      if: inputs.run-security-scan == 'true' && (inputs.mode == 'full' || inputs.mode == 'security')
      shell: bash
      run: |
        echo "ðŸ”’ Running security scans..."

        # Install and run bandit if available
        if command -v bandit >/dev/null 2>&1; then
          echo "ðŸ” Running bandit security scan..."
          bandit -r ${{ inputs.source-directory }} -f json -o bandit-report.json || echo "âš ï¸ Security issues found"
        else
          echo "âš ï¸ Bandit not available, skipping security scan"
        fi

        echo "âœ… Security scan completed"

    - name: ðŸ§ª Run Tests
      id: test
      if: inputs.mode == 'full' || inputs.mode == 'test'
      shell: bash
      run: |
        echo "ðŸ§ª Running tests..."

        # Check if pytest is available
        if command -v pytest >/dev/null 2>&1; then
          echo "ðŸ” Running pytest with coverage..."

          # Run tests with coverage
          pytest ${{ inputs.test-directory }} \
            --cov=${{ inputs.source-directory }} \
            --cov-report=xml \
            --cov-report=term \
            --cov-fail-under=${{ inputs.coverage-threshold }} \
            --junitxml=test-results.xml

          # Extract coverage percentage
          if [ -f "coverage.xml" ]; then
            COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); root = tree.getroot(); coverage = root.get('line-rate'); print(f'{float(coverage)*100:.1f}' if coverage else '0')" 2>/dev/null || echo "0")
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "ðŸ“Š Coverage: ${COVERAGE}%"
          else
            echo "coverage=0" >> $GITHUB_OUTPUT
          fi
        else
          echo "âš ï¸ Pytest not available, skipping tests"
          echo "coverage=0" >> $GITHUB_OUTPUT
        fi

        echo "âœ… Tests completed"

    - name: ðŸ“¦ Build Package
      id: build
      if: inputs.mode == 'full' || inputs.mode == 'build'
      shell: bash
      run: |
        echo "ðŸ“¦ Building package..."

        # Clean any existing build artifacts
        rm -rf dist/ build/ *.egg-info/

        # Build the package
        if uv build; then
          echo "success=true" >> $GITHUB_OUTPUT
          echo "âœ… Package built successfully"

          # Get package version from built wheel
          if ls dist/*.whl >/dev/null 2>&1; then
            WHEEL_FILE=$(ls dist/*.whl | head -1)
            VERSION=$(basename "$WHEEL_FILE" | sed 's/.*-\([^-]*\)-py.*/\1/')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Package version: $VERSION"

            # List built artifacts
            echo "ðŸ“‹ Built artifacts:"
            ls -la dist/
          else
            echo "version=unknown" >> $GITHUB_OUTPUT
          fi
        else
          echo "success=false" >> $GITHUB_OUTPUT
          echo "âŒ Package build failed"
          exit 1
        fi

    - name: ðŸ“¤ Upload Artifacts
      if: inputs.upload-artifacts == 'true' && (inputs.mode == 'full' || inputs.mode == 'build')
      uses: actions/upload-artifact@v4
      with:
        name: python-packages
        path: dist/
        retention-days: 90

    - name: ðŸ“Š Upload Test Results
      if: always() && inputs.upload-artifacts == 'true' && (inputs.mode == 'full' || inputs.mode == 'test')
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          test-results.xml
          coverage.xml
          bandit-report.json
        retention-days: 30

    - name: ðŸ“‹ CI Summary
      shell: bash
      run: |
        echo "## ðŸ”„ Python CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
        echo "- Python: ${{ steps.python.outputs.python-version }}" >> $GITHUB_STEP_SUMMARY
        echo "- Mode: ${{ inputs.mode }}" >> $GITHUB_STEP_SUMMARY
        echo "- Quality Checks: ${{ inputs.run-quality-checks }}" >> $GITHUB_STEP_SUMMARY
        echo "- Security Scan: ${{ inputs.run-security-scan }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ inputs.mode }}" = "full" ] || [ "${{ inputs.mode }}" = "test" ]; then
          echo "**Test Results:**" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage: ${{ steps.test.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY
          echo "- Threshold: ${{ inputs.coverage-threshold }}%" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ inputs.mode }}" = "full" ] || [ "${{ inputs.mode }}" = "build" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Results:**" >> $GITHUB_STEP_SUMMARY
          echo "- Success: ${{ steps.build.outputs.success }}" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${{ steps.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Artifacts: ${{ inputs.upload-artifacts }}" >> $GITHUB_STEP_SUMMARY
        fi

branding:
  icon: 'check-circle'
  color: 'green'