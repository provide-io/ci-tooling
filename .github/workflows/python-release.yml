name: 'Reusable Python Release'

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        type: string
        default: '3.11'
      uv-version:
        description: 'UV version to use'
        type: string
        default: '0.7.8'
      build-backend:
        description: 'Build backend (uv, build)'
        type: string
        default: 'uv'
      repository-url:
        description: 'PyPI repository URL'
        type: string
        default: 'https://upload.pypi.org/legacy/'
      skip-existing:
        description: 'Skip if package already exists'
        type: boolean
        default: true
      prerelease:
        description: 'Mark as prerelease'
        type: boolean
        default: false
      run-tests:
        description: 'Run tests before release'
        type: boolean
        default: true
      test-repository:
        description: 'Test on TestPyPI first'
        type: boolean
        default: false
      publish-testpypi:
        description: 'Actually publish to TestPyPI (release gate - requires manual approval)'
        type: boolean
        default: false
      publish-pypi:
        description: 'Actually publish to PyPI (release gate - requires manual approval)'
        type: boolean
        default: false
      parallel-tests:
        description: 'Run tests in parallel with pytest-xdist'
        type: boolean
        default: true
    secrets:
      PYPI_TOKEN:
        description: 'PyPI API token (required only if publish-pypi is true)'
        required: false
      TEST_PYPI_TOKEN:
        description: 'TestPyPI API token (required only if publish-testpypi is true)'
        required: false

env:
  FORCE_COLOR: "1"
  UV_SYSTEM_PYTHON: "1"

jobs:
  # ==================================================================================
  # ðŸ§ª Pre-release Tests
  # ==================================================================================
  pre-release-tests:
    name: ðŸ§ª Pre-release Tests
    if: inputs.run-tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python Environment
        uses: provide-io/ci-tooling/actions/setup-python-env@main
        with:
          python-version: ${{ inputs.python-version }}
          uv-version: ${{ inputs.uv-version }}

      - name: ðŸŽ¨ Quality Checks
        uses: provide-io/ci-tooling/actions/python-quality@main

      - name: ðŸ§ª Run Tests
        uses: provide-io/ci-tooling/actions/python-test@main
        with:
          coverage-threshold: 0
          parallel: ${{ inputs.parallel-tests }}

  # ==================================================================================
  # ðŸ—ï¸ Build Package
  # ==================================================================================
  build:
    name: ðŸ—ï¸ Build Package
    needs: [pre-release-tests]
    if: always() && (needs.pre-release-tests.result == 'success' || !inputs.run-tests)
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python Environment
        uses: provide-io/ci-tooling/actions/setup-python-env@main
        with:
          python-version: ${{ inputs.python-version }}
          uv-version: ${{ inputs.uv-version }}

      - name: ðŸ—ï¸ Build Package
        uses: provide-io/ci-tooling/actions/python-build@main
        with:
          build-backend: ${{ inputs.build-backend }}

      - name: ðŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: dist/*
          retention-days: 30

  # ==================================================================================
  # ðŸ·ï¸ Create GitHub Release
  # ==================================================================================
  github-release:
    name: ðŸ·ï¸ GitHub Release
    needs: [build]
    if: always() && needs.build.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: dist/

      - name: ðŸ“‹ Get Version Info
        id: version
        shell: bash
        run: |
          WHEEL_FILE=$(ls dist/*.whl | head -1 2>/dev/null || echo "")
          if [ -n "$WHEEL_FILE" ]; then
            PACKAGE_INFO=$(python3 -c 'import re,sys,os; f=os.path.basename(sys.argv[1]); m=re.match(r"^([^-]+)-([^-]+)", f); print(f"{m.group(1)} {m.group(2)}" if m else "unknown 0.0.0")' "$WHEEL_FILE")
            PACKAGE_NAME=$(echo "$PACKAGE_INFO" | cut -d' ' -f1)
            PACKAGE_VERSION=$(echo "$PACKAGE_INFO" | cut -d' ' -f2)
          else
            PACKAGE_NAME="unknown"
            PACKAGE_VERSION="0.0.0"
          fi
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Package: $PACKAGE_NAME v$PACKAGE_VERSION"

      - name: ðŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.package_version }}
          name: v${{ steps.version.outputs.package_version }}
          files: dist/*
          generate_release_notes: true
          prerelease: ${{ inputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Release Summary
        shell: bash
        run: |
          echo "## ðŸ·ï¸ GitHub Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** ${{ steps.version.outputs.package_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.package_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la dist/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.package_version }})" >> $GITHUB_STEP_SUMMARY

  # ==================================================================================
  # ðŸš§ PyPI Publishing Gate
  # ==================================================================================
  publishing-gate:
    name: ðŸš§ Publishing Gate
    needs: [github-release]
    if: always() && needs.github-release.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“‹ Report Gate Status
        run: |
          echo "## ðŸš§ PyPI Publishing Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "GitHub Release created successfully. PyPI publishing is gated by default." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Target | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.publish-testpypi }}" != "true" ]; then
            echo "| TestPyPI | â¸ï¸ **Gated** (re-run with \`publish-testpypi: true\`) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| TestPyPI | âœ… Enabled |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ inputs.publish-pypi }}" != "true" ]; then
            echo "| PyPI | â¸ï¸ **Gated** (re-run with \`publish-pypi: true\`) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| PyPI | âœ… Enabled |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### How to Publish to PyPI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Re-run this workflow with the publish flags enabled:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
          echo "with:" >> $GITHUB_STEP_SUMMARY
          echo "  publish-testpypi: true  # Optional: publish to TestPyPI first" >> $GITHUB_STEP_SUMMARY
          echo "  publish-pypi: true      # Publish to PyPI" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ==================================================================================
  # ðŸ§ª Test Release (TestPyPI)
  # ==================================================================================
  test-release:
    name: ðŸ§ª Test Release
    needs: build
    if: inputs.test-repository && inputs.publish-testpypi
    runs-on: ubuntu-latest
    environment: testpypi
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ Setup Python Environment
        uses: provide-io/ci-tooling/actions/setup-python-env@main
        with:
          python-version: ${{ inputs.python-version }}
          uv-version: ${{ inputs.uv-version }}

      - name: ðŸ“¦ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: dist/

      - name: ðŸ§ª Test Release to TestPyPI
        uses: provide-io/ci-tooling/actions/python-release@main
        with:
          pypi-token: ${{ secrets.TEST_PYPI_TOKEN }}
          repository-url: 'https://test.pypi.org/legacy/'
          create-github-release: false
          skip-existing: true

      - name: âœ… Verify TestPyPI Installation
        shell: bash
        run: |
          source ./workenv/bin/activate

          # Get package name and version (simplified)
          WHEEL_FILE=$(ls dist/*.whl | head -1 2>/dev/null || echo "")
          if [ -n "$WHEEL_FILE" ]; then
            PACKAGE_INFO=$(python3 -c 'import re,sys,os; f=os.path.basename(sys.argv[1]); m=re.match(r"^([^-]+)-([^-]+)", f); print(f"{m.group(1)} {m.group(2)}" if m else "unknown 0.0.0")' "$WHEEL_FILE")
          else
            PACKAGE_INFO="unknown 0.0.0"
          fi

          if [ -n "$PACKAGE_INFO" ]; then
            PACKAGE_NAME=$(echo "$PACKAGE_INFO" | cut -d' ' -f1)
            PACKAGE_VERSION=$(echo "$PACKAGE_INFO" | cut -d' ' -f2)

            echo "ðŸ” Testing installation of $PACKAGE_NAME==$PACKAGE_VERSION from TestPyPI"

            # Create fresh environment for testing
            uv venv test-env
            source test-env/bin/activate

            # Install from TestPyPI
            uv pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ "$PACKAGE_NAME==$PACKAGE_VERSION"

            # Basic import test
            python -c "import $PACKAGE_NAME; print(f'âœ… Successfully imported {$PACKAGE_NAME}')" || \
            python -c "import ${PACKAGE_NAME//-/_}; print(f'âœ… Successfully imported ${PACKAGE_NAME//-/_}')" || \
            echo "âš ï¸ Could not import package, but installation succeeded"

            echo "âœ… TestPyPI installation verification completed"
          else
            echo "âš ï¸ Could not determine package info for testing"
          fi

  # ==================================================================================
  # ðŸš€ Production Release
  # ==================================================================================
  release:
    name: ðŸš€ Production Release
    needs: [build, test-release]
    if: >-
      always() &&
      needs.build.result == 'success' &&
      inputs.publish-pypi &&
      (needs.test-release.result == 'success' || !inputs.test-repository || !inputs.publish-testpypi)
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      contents: write
      id-token: write
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python Environment
        uses: provide-io/ci-tooling/actions/setup-python-env@main
        with:
          python-version: ${{ inputs.python-version }}
          uv-version: ${{ inputs.uv-version }}

      - name: ðŸ“¦ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: dist/

      - name: ðŸ“ Generate Release Notes
        id: release-notes
        shell: bash
        run: |
          # Try to extract release notes from CHANGELOG.md
          if [ -f "CHANGELOG.md" ]; then
            echo "ðŸ“ Extracting release notes from CHANGELOG.md..."

            # Extract release notes from changelog (simplified)
            if [ -f "CHANGELOG.md" ]; then
              echo "Release notes from CHANGELOG.md" > release-notes.md
              echo "âœ… Using CHANGELOG.md for release notes"
            else
              echo "ðŸ“ No CHANGELOG.md found, will generate basic notes"
            fi

            if [ ! -f "release-notes.md" ]; then
              echo "## Release Notes" > release-notes.md
              echo "" >> release-notes.md
              echo "Automated release with ci-tooling" >> release-notes.md
              echo "" >> release-notes.md
              echo "### Installation" >> release-notes.md
              echo "\`\`\`bash" >> release-notes.md
              echo "pip install package-name" >> release-notes.md
              echo "\`\`\`" >> release-notes.md
            fi
          else
            echo "## Release Notes" > release-notes.md
            echo "" >> release-notes.md
            echo "Automated release" >> release-notes.md
            echo "" >> release-notes.md
            echo "### Installation" >> release-notes.md
            echo "\`\`\`bash" >> release-notes.md
            echo "pip install package-name" >> release-notes.md
            echo "\`\`\`" >> release-notes.md
          fi

      - name: ðŸš€ Release to PyPI
        uses: provide-io/ci-tooling/actions/python-release@main
        with:
          pypi-token: ${{ secrets.PYPI_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository-url: ${{ inputs.repository-url }}
          skip-existing: ${{ inputs.skip-existing }}
          prerelease: ${{ inputs.prerelease }}
          release-notes-file: 'release-notes.md'

      - name: ðŸ“Š Release Summary
        shell: bash
        run: |
          echo "## ðŸŽ‰ Release Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get package info (reuse previous logic)
          WHEEL_FILE=$(ls dist/*.whl | head -1 2>/dev/null || echo "")
          if [ -n "$WHEEL_FILE" ]; then
            PACKAGE_INFO=$(python3 -c 'import re,sys,os; f=os.path.basename(sys.argv[1]); m=re.match(r"^([^-]+)-([^-]+)", f); print(f"{m.group(1)} {m.group(2)}" if m else "unknown 0.0.0")' "$WHEEL_FILE")
          else
            PACKAGE_INFO="unknown 0.0.0"
          fi

          if [ -n "$PACKAGE_INFO" ]; then
            PACKAGE_NAME=$(echo "$PACKAGE_INFO" | cut -d' ' -f1)
            PACKAGE_VERSION=$(echo "$PACKAGE_INFO" | cut -d' ' -f2)

            echo "**Package:** $PACKAGE_NAME" >> $GITHUB_STEP_SUMMARY
            echo "**Version:** $PACKAGE_VERSION" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¦ Installation" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "pip install $PACKAGE_NAME==$PACKAGE_VERSION" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
            echo "- [PyPI Package](https://pypi.org/project/$PACKAGE_NAME/$PACKAGE_VERSION/)" >> $GITHUB_STEP_SUMMARY
            echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v$PACKAGE_VERSION)" >> $GITHUB_STEP_SUMMARY
          fi