name: 'âš™ï¸ Continuous Integration'

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        type: string
        default: '3.11'
      uv-version:
        description: 'UV version to use'
        type: string
        default: '0.7.8'
      source-paths:
        description: 'Source paths for quality checks'
        type: string
        default: 'src/ tests/'
      test-directory:
        description: 'Test directory'
        type: string
        default: 'tests/'
      coverage-threshold:
        description: 'Coverage threshold percentage'
        type: number
        default: 80
      run-security:
        description: 'Run security scanning (bandit)'
        type: boolean
        default: true
      run-secret-scan:
        description: 'Run secret scanning (TruffleHog, Gitleaks)'
        type: boolean
        default: true
      run-performance:
        description: 'Run performance tests'
        type: boolean
        default: false
      matrix-testing:
        description: 'Enable matrix testing across Python versions'
        type: boolean
        default: false
      os-matrix:
        description: 'Operating systems to test on'
        type: string
        default: 'ubuntu-latest'
      fail-fast:
        description: 'Fail fast in matrix builds'
        type: boolean
        default: false
      upload-coverage:
        description: 'Upload coverage to Codecov'
        type: boolean
        default: false
      parallel-testing:
        description: 'Enable parallel test execution with pytest-xdist (may break with some pytest plugins)'
        type: boolean
        default: true
    secrets:
      CODECOV_TOKEN:
        description: 'Codecov token for coverage upload'
        required: false

env:
  # NOTE: Do NOT set FORCE_COLOR=1 here - it breaks pytest-xdist's execnet
  # subprocess communication which expects plain output during bootstrap
  UV_SYSTEM_PYTHON: "1"

jobs:
  # ==================================================================================
  # ðŸ”§ Code Quality & Type Checking
  # ==================================================================================
  quality:
    name: ðŸ”§ Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¥ Checkout ci-tooling
        uses: actions/checkout@v4
        with:
          repository: provide-io/ci-tooling
          ref: v0
          path: .ci-tooling

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: âš¡ Install UV
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ inputs.uv-version }}
          enable-cache: true

      - name: ðŸ“¦ Install dependencies
        run: uv sync --group dev

      - name: ðŸŽ¨ Check formatting with Ruff
        run: |
          source .venv/bin/activate
          .ci-tooling/scripts/quality/run-ruff-format.sh "${{ inputs.source-paths }}" true

      - name: ðŸ” Lint with Ruff
        run: |
          source .venv/bin/activate
          .ci-tooling/scripts/quality/run-ruff-lint.sh "${{ inputs.source-paths }}" false

      - name: ðŸ”’ Type check with MyPy
        run: |
          source .venv/bin/activate
          .ci-tooling/scripts/quality/run-mypy.sh src/ false || true

  # ==================================================================================
  # ðŸ§ª Tests
  # ==================================================================================
  test:
    name: ðŸ§ª Tests
    needs: quality
    strategy:
      fail-fast: ${{ inputs.fail-fast }}
      matrix:
        os: ${{ fromJson(format('["{0}"]', inputs.os-matrix)) }}
        python-version: ${{ fromJson(inputs.matrix-testing && '["3.11", "3.12", "3.13"]' || format('["{0}"]', inputs.python-version)) }}
    runs-on: ${{ matrix.os }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¥ Checkout ci-tooling
        uses: actions/checkout@v4
        with:
          repository: provide-io/ci-tooling
          ref: v0
          path: .ci-tooling

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: âš¡ Install UV
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ inputs.uv-version }}
          enable-cache: true

      - name: ðŸ“¦ Install dependencies
        run: uv sync --group dev

      - name: ðŸ§ª Run Tests
        run: |
          source .venv/bin/activate
          .ci-tooling/scripts/test/run-pytest.sh "${{ inputs.test-directory }}" ${{ inputs.coverage-threshold }} ${{ inputs.parallel-testing }}

      - name: ðŸ“¤ Upload Coverage
        if: inputs.upload-coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage.xml
          flags: unittests
          name: codecov-${{ matrix.os }}-py${{ matrix.python-version }}

  # ==================================================================================
  # ðŸ”’ Security Scanning
  # ==================================================================================
  security:
    name: ðŸ”’ Security
    needs: quality
    if: inputs.run-security
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¥ Checkout ci-tooling
        uses: actions/checkout@v4
        with:
          repository: provide-io/ci-tooling
          ref: v0
          path: .ci-tooling

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: âš¡ Install UV
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ inputs.uv-version }}
          enable-cache: true

      - name: ðŸ“¦ Install dependencies
        run: |
          uv sync --group dev
          source .venv/bin/activate
          uv pip install bandit pip-audit

      - name: ðŸ”’ Run Bandit security scan
        run: |
          source .venv/bin/activate
          .ci-tooling/scripts/security/run-bandit.sh src/ bandit-report.json -ll

      - name: ðŸ” Check for known vulnerabilities
        run: |
          source .venv/bin/activate
          .ci-tooling/scripts/security/run-pip-audit.sh pip-audit-report.json

      - name: ðŸ“¤ Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            pip-audit-report.json

  # ==================================================================================
  # ðŸ” Secret Scanning
  # ==================================================================================
  secret-scan:
    name: ðŸ” Secret Scan
    needs: quality
    if: inputs.run-secret-scan
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” TruffleHog Scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified
        continue-on-error: true

      - name: ðŸ” Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  # ==================================================================================
  # ðŸ“¦ Build Package
  # ==================================================================================
  build:
    name: ðŸ“¦ Build
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: âš¡ Install UV
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ inputs.uv-version }}
          enable-cache: false  # Build doesn't need cache, just runs uv build

      - name: ðŸ“¦ Build Package
        run: uv build

      - name: ðŸ“¤ Upload Dist Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  # ==================================================================================
  # ðŸ“‹ CI Summary
  # ==================================================================================
  summary:
    name: ðŸ“‹ CI Summary
    needs: [quality, test, security, secret-scan, build]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“‹ Generate Summary
        run: |
          echo "## ðŸŽ¯ CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quality | ${{ needs.quality.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.run-security }}" = "true" ]; then
            echo "| Security | ${{ needs.security.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ inputs.run-secret-scan }}" = "true" ]; then
            echo "| Secret Scan | ${{ needs.secret-scan.result == 'success' && 'âœ… Passed' || 'âš ï¸ Issues' }} |" >> $GITHUB_STEP_SUMMARY
          fi

          # Overall status
          OVERALL="âœ… Success"
          if [ "${{ needs.quality.result }}" != "success" ] || [ "${{ needs.test.result }}" != "success" ] || [ "${{ needs.build.result }}" != "success" ]; then
            OVERALL="âŒ Failed"
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Result:** $OVERALL" >> $GITHUB_STEP_SUMMARY
